<!DOCTYPE html>
<html>
<head>
  <title>Famished Famished Flamingoes</title>
  <link rel="stylesheet" href="styles.css" />
  <style>
    table.lobby {
      margin: 2em auto;
      border-collapse: collapse;
    }
    th, td {
      padding: 1em;
      border: 1px solid #ccc;
      min-width: 100px;
      cursor: pointer;
      text-align: center;
    }
    td.taken {
      color: white;
      font-weight: bold;
    }
    .btn-start {
      display: block;
      margin: 2em auto;
      font-size: 1.5em;
      padding: 1em 2em;
      background: #333;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h1>ðŸ¦© Famished Famished Flamingoes Lobby</h1>

  <table class="lobby">
    <thead>
      <tr>
        <th>Team</th>
        <th>Flamingo</th>
        <th>Shrimp Dropper</th>
        <th>Congress</th>
      </tr>
    </thead>
    <tbody id="lobby-body"></tbody>
  </table>

  <button id="start-btn" class="btn-start">Start Game</button>

  <script type="module">
    import { connect, sendEvent } from './js/client.js';

    const lobbyBody = document.getElementById('lobby-body');
    const startBtn = document.getElementById('start-btn');

    let currentTeam = null;
    let currentRole = null;

    let hasRedirected = false;

    connect((state) => {
      const lobby = state.lobby;
      lobbyBody.innerHTML = ''; // <-- this ensures a clean redraw

      for (const [team, roles] of Object.entries(lobby)) {
        const row = document.createElement('tr');
        row.innerHTML = `
      <td class="team-${team}">${team.toUpperCase()}</td>
      ${Object.entries(roles).map(([role, player]) => {
        const taken = !!player;
        const classes = taken ? `taken team-${team}-bg` : '';
        return `<td data-team="${team}" data-role="${role}" class="${classes}">
          ${taken ? 'âœ”' : ''}
        </td>`;
      }).join('')}
    `;
        lobbyBody.appendChild(row);
      }

      // re-attach click handlers after rebuilding
      lobbyBody.querySelectorAll('td[data-team]').forEach(cell => {
        const team = cell.dataset.team;
        const role = cell.dataset.role;
        if (!cell.classList.contains('taken')) {
          cell.onclick = () => {
            currentTeam = team;
            currentRole = role;
            sendEvent('SELECT_ROLE', { team, role });
          };
        }
      });

      if (
        state.gameStarted &&
        !hasRedirected &&
        currentTeam &&
        currentRole
      ) {
        hasRedirected = true;
        const teamToRedirect = currentTeam;
        const roleToRedirect = currentRole;
        currentTeam = null;
        currentRole = null;
        redirectToGame(teamToRedirect, roleToRedirect);
      }
    });

    startBtn.addEventListener('click', () => {
      sendEvent('START_GAME', {});
    });

    function redirectToGame(team, role) {
      let page = '';
      if (role === 'flamingo') page = 'flamingo.html';
      if (role === 'dropper') page = 'shrimpdropper.html';
      if (role === 'congress') page = 'picketing.html';

      window.location.href = `${page}?team=${team}`;
    }
  </script>
</body>
</html>
